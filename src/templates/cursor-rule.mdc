---
description: Mermaid diagram best practices and @lekman/mmd tool usage. Apply when creating, editing, or reviewing Mermaid diagrams, .mmd files, or diagram-related Markdown.
globs: "*.mmd,*.md"
alwaysApply: false
---

# Mermaid Diagram Guidelines

## Tool Workflow

- Edit `.mmd` files in `docs/mmd/`, not inline Mermaid in Markdown
- Run `mmd sync` after editing to generate themed SVGs and update Markdown
- Commands:
  - `mmd extract` — scan `.md` files, extract fenced Mermaid blocks to `docs/mmd/*.mmd`
  - `mmd render` — render `.mmd` files to SVGs using `.mermaid.json` theme config
  - `mmd render --force` — re-render all diagrams regardless of timestamps
  - `mmd inject` — replace `<!-- mmd:name -->` anchors in `.md` files with markdown image refs
  - `mmd sync` — run extract + render + inject in sequence
  - `mmd sync [files...]` — process specific `.md` files instead of all
  - `mmd check` — lint for orphaned inline Mermaid blocks in managed files
  - `mmd init` — install AI coding assistant rule files into the repo
  - `mmd config` — write default `.mermaid.json` to the repository root
- Config: `.mermaid.json` at repo root defines theme mode (light/dark), themes, and output directory
- Anchors: `<!-- mmd:name -->` HTML comments link Markdown locations to diagrams
- Render uses mtime comparison: `.mmd` and `.mermaid.json` are checked; SVGs re-rendered when stale
- Primary renderer: beautiful-mermaid (flowchart, state)
- Fallback renderer: mmdc (sequence, class, ER, C4, gantt, pie, gitgraph, mindmap, timeline, quadrant, kanban, requirement, architecture)

## Syntax Best Practices

### Node and Edge Naming
- Use descriptive node IDs: `userService`, `authController`, `orderDb` not `A`, `B`, `C`
- Short edge labels (1-3 words): `-->|yes|`, `-->|on failure|`, `-->|HTTP/443|`
- Wrap labels with special characters in quotes: `["User Service (v2)"]`

### Layout Direction
- `TD` (top-down): hierarchies, org charts, dependency trees
- `LR` (left-right): sequential flows, pipelines, timelines
- `RL` / `BT`: use sparingly for specific visual needs

### Diagram Structure
- Use subgraphs to group related nodes and add visual structure
- Keep diagrams under 15-20 nodes; split larger concepts into linked diagrams
- One concept per diagram — do not combine unrelated flows

### Node Shapes
- `[rectangle]` — process or action step
- `{diamond}` — decision point
- `([stadium])` — start or end point
- `[(cylinder)]` — database or data store
- `((circle))` — event or trigger

### Diagram Types and When to Use
- **Sequence**: API call chains, user flows, service-to-service communication
- **Flowchart**: decision trees, CI/CD pipelines, any boxes-and-arrows diagram
- **Class**: domain models, interface hierarchies, type documentation
- **C4 (Context/Container/Component)**: system architecture at different zoom levels
- **State**: lifecycle diagrams, object state transitions
- **ER**: database schema relationships
- **Gitgraph**: branching strategies, merge/release processes
- **Mindmap**: brainstorming, concept hierarchies (keep depth to 3-4 levels)
- **Timeline**: project roadmaps, incident timelines
- **Quadrant**: effort vs impact, priority matrices
- **Kanban**: workflow stages, sprint boards
- **Requirement**: traceability for regulated projects (SysML notation)
- **Architecture**: cloud infrastructure, network topology with iconographic notation

### Sequence Diagram Tips
- Use `participant` for explicit ordering, `actor` for human actors
- `autonumber` adds sequential message numbering for referencing in text
- `alt`/`else` for conditional branches, `loop` for iterations, `par` for parallel paths

### C4 Diagram Tips
- Level 1 (Context): 5-10 elements, 30,000ft view, use `System_Ext` for external systems
- Level 2 (Container): one container per deployed unit, show protocols on relationships
- Level 3 (Component): map to actual source directories, show interfaces between components
- Do not mix C4 and Class syntax in one diagram

### Requirement Diagram Warning
- Parser requires zero indentation inside `requirement {}` blocks — indented syntax causes parse errors

## Authoring Rules

- Write `.mmd` files in `docs/mmd/`, never inline Mermaid in Markdown fenced blocks
- Do not edit generated SVGs or markdown image tags — they are regenerated by `mmd inject`
- Do not add `%%{init}` theme directives — the tool prepends theme config during rendering
- Give diagrams meaningful names via the anchor comment: `<!-- mmd:system-context -->`
- Commit both `.mmd` source files and generated `.svg` files to version control
- Use the VS Code Mermaid Chart extension (`MermaidChart.vscode-mermaid-chart`) for live preview
  - Note: extension preview uses Mermaid's default theme; final SVGs use `.mermaid.json` config
- Run `mmd check` to find orphaned inline Mermaid blocks that should be extracted

## File Structure

```
repo/
  .mermaid.json              # Theme config (light/dark themes, output dir)
  docs/
    ARCHITECTURE.md          # Contains <!-- mmd:xxx --> anchors + image refs
    mmd/
      system-context.mmd     # Source diagram
      system-context.svg     # Rendered SVG (themed per config mode)
```

## Injected Output Format

Standard markdown image format, compatible with GitHub and VS Code:

```markdown
<!-- mmd:system-context -->
![System Context](docs/mmd/system-context.svg)
```
