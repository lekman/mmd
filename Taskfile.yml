# https://taskfile.dev

version: "3"

includes:
  git:
    taskfile: ./node_modules/@northbridge-security/ai-toolkit/tasks/git.yml
    dir: .
  json:
    taskfile: ./node_modules/@northbridge-security/ai-toolkit/tasks/json.yml
    dir: .
  yaml:
    taskfile: ./node_modules/@northbridge-security/ai-toolkit/tasks/yaml.yml
    aliases:
      - yml
    dir: .
  markdown:
    taskfile: ./node_modules/@northbridge-security/ai-toolkit/tasks/markdown.yml
    aliases:
      - md
    dir: .
  security:
    taskfile: ./node_modules/@northbridge-security/ai-toolkit/tasks/security.yml
    aliases:
      - s
    dir: .

vars:
  PROJECT_NAME: "mmd"

tasks:
  install:
    desc: "Install/upgrade required development tools"
    aliases: [i]
    silent: true
    cmds:
      - |
        set -euo pipefail

        GREEN='\033[0;32m'
        YELLOW='\033[0;33m'
        CYAN='\033[0;36m'
        RED='\033[0;31m'
        NC='\033[0m'

        echo -e "${CYAN}Installing Development Tools${NC}"
        echo "---"

        # Check if Homebrew is installed
        if ! command -v brew &>/dev/null; then
          echo -e "${RED}Error:${NC} Homebrew is not installed"
          echo "Install from: https://brew.sh"
          exit 1
        fi

        # Install or upgrade bun
        echo -e "${GREEN}Checking bun...${NC}"
        if brew list oven-sh/bun/bun &>/dev/null; then
          echo -e "${YELLOW}Upgrading bun...${NC}"
          brew upgrade oven-sh/bun/bun
        else
          echo -e "${YELLOW}Installing bun...${NC}"
          brew install oven-sh/bun/bun
        fi

        # Install or upgrade go-task
        echo -e "${GREEN}Checking go-task...${NC}"
        if brew list go-task &>/dev/null; then
          echo -e "${YELLOW}Upgrading go-task...${NC}"
          brew upgrade go-task
        else
          echo -e "${YELLOW}Installing go-task...${NC}"
          brew install go-task
        fi

        # Install or upgrade semgrep
        echo -e "${GREEN}Checking semgrep...${NC}"
        if brew list semgrep &>/dev/null; then
          echo -e "${YELLOW}Upgrading semgrep...${NC}"
          brew upgrade semgrep
        else
          echo -e "${YELLOW}Installing semgrep...${NC}"
          brew install semgrep
        fi

        # Install project dependencies
        echo ""
        echo -e "${GREEN}Installing project dependencies...${NC}"
        bun install

        echo ""
        echo -e "${GREEN}✓${NC} All tools installed successfully"

  default:
    desc: "Show available mmd tasks"
    aliases: [help, h]
    silent: true
    cmds:
      - |
        GREEN='\033[0;32m'
        YELLOW='\033[0;33m'
        BLUE='\033[0;34m'
        CYAN='\033[0;36m'
        BOLD='\033[1m'
        NC='\033[0m'

        echo -e "${BOLD}@lekman/mmd — Mermaid Diagram Management CLI${NC}"
        echo ""
        echo "Command                            Alias     Description"
        echo "────────────────────────────────────────────────────────────────────────────────"
        echo -e "${BOLD}Setup:${NC}"
        echo -e "  ${GREEN}task install${NC}                     ${YELLOW}i${NC}         Install/upgrade required tools"
        echo ""
        echo -e "${BOLD}Development:${NC}"
        echo -e "  ${GREEN}task lint${NC}                        ${YELLOW}l${NC}         Run linting checks"
        echo -e "  ${GREEN}task format${NC}                      ${YELLOW}fmt${NC}       Format code"
        echo -e "  ${GREEN}task typecheck${NC}                   ${YELLOW}tc${NC}        Run TypeScript type checking"
        echo -e "  ${GREEN}task test${NC}                        ${YELLOW}t${NC}         Run tests"
        echo -e "  ${GREEN}task test:coverage${NC}               ${YELLOW}cov${NC}       Run tests with coverage report"
        echo -e "  ${GREEN}task quality${NC}                     ${YELLOW}q${NC}         Run all quality checks"
        echo -e "  ${GREEN}task build${NC}                       ${YELLOW}b${NC}         Bundle CLI for distribution"
        echo ""
        echo -e "${BOLD}Security:${NC}"
        echo -e "  ${GREEN}task security:scan${NC}               ${YELLOW}s:s${NC}       Run semgrep security scanner"
        echo ""
        echo -e "${BOLD}Task Libraries:${NC}"
        echo -e "  ${GREEN}task git:<command>${NC}                         Git & GitHub operations"
        echo -e "  ${GREEN}task json:<command>${NC}                        JSON linting & validation"
        echo -e "  ${GREEN}task yaml:<command>${NC}              ${YELLOW}yml${NC}       YAML linting & validation"
        echo -e "  ${GREEN}task markdown:<command>${NC}          ${YELLOW}md${NC}        Markdown linting & validation"
        echo -e "  ${GREEN}task security:<command>${NC}          ${YELLOW}s${NC}         Security scanning tools"
        echo ""
        echo -e "${BLUE}Run 'task --list' to see all available tasks${NC}"

  lint:
    desc: "Run linting checks"
    aliases: [l]
    silent: true
    cmds:
      - |
        GREEN='\033[0;32m'
        NC='\033[0m'

        echo -e "${GREEN}Running linting...${NC}"
        bunx turbo run lint

  format:
    desc: "Format code"
    aliases: [fmt]
    silent: true
    cmds:
      - |
        GREEN='\033[0;32m'
        NC='\033[0m'

        echo -e "${GREEN}Formatting code...${NC}"
        bun run format

  typecheck:
    desc: "Run TypeScript type checking"
    aliases: [tc]
    silent: true
    cmds:
      - |
        GREEN='\033[0;32m'
        NC='\033[0m'

        echo -e "${GREEN}Type checking...${NC}"
        bunx turbo run typecheck

  test:
    desc: "Run tests"
    aliases: [t]
    silent: true
    cmds:
      - |
        GREEN='\033[0;32m'
        NC='\033[0m'

        echo -e "${GREEN}Running tests...${NC}"
        bunx turbo run test

  test:coverage:
    desc: "Run tests with coverage report"
    aliases: [cov]
    silent: true
    cmds:
      - |
        GREEN='\033[0;32m'
        CYAN='\033[0;36m'
        NC='\033[0m'

        echo -e "${GREEN}Running unit tests with coverage...${NC}"
        bunx turbo run test:coverage
        echo ""
        echo -e "${CYAN}Coverage report generated:${NC}"
        echo -e "  LCOV: ${GREEN}coverage/lcov.info${NC}"

  quality:
    desc: "Run all quality checks (lint, typecheck, security, test)"
    aliases: [q]
    silent: true
    cmds:
      - |
        GREEN='\033[0;32m'
        CYAN='\033[0;36m'
        NC='\033[0m'

        echo -e "${CYAN}Running Quality Checks${NC}"
        echo "---"
      - task: lint
      - task: typecheck
      - task: security:scan
      - task: test
      - |
        GREEN='\033[0;32m'
        NC='\033[0m'

        echo ""
        echo -e "${GREEN}✓${NC} All quality checks passed"

  build:
    desc: "Bundle CLI for distribution"
    aliases: [b]
    silent: true
    cmds:
      - |
        GREEN='\033[0;32m'
        NC='\033[0m'

        echo -e "${GREEN}Building CLI...${NC}"
        bun run build
        echo -e "${GREEN}✓${NC} dist/cli.js built"
